<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>spark.spec-tacular.datomic documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html">Spec-tacular 0.5.0 API documentation</a></h1></div><div class="sidebar" id="namespaces"><h3><a href="index.html"><span class="inner">Namespaces</span></a></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spark</span></div></div></li><li class="depth-2"><a href="spark.spec-tacular.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec-tacular</span></div></a></li><li class="depth-3 branch current"><a href="spark.spec-tacular.datomic.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datomic</span></div></a></li><li class="depth-3 branch"><a href="spark.spec-tacular.generators.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generators</span></div></a></li><li class="depth-3"><a href="spark.spec-tacular.schema.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema</span></div></a></li></ul></div><div class="sidebar" id="vars"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-assoc.21"><div class="inner"><span>assoc!</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-ConnCtx"><div class="inner"><span>ConnCtx</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-Connection"><div class="inner"><span>Connection</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-count-all-by-spec"><div class="inner"><span>count-all-by-spec</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-create.21"><div class="inner"><span>create!</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-create-graph.21"><div class="inner"><span>create-graph!</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-Database"><div class="inner"><span>Database</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-db"><div class="inner"><span>db</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-get-all-by-spec"><div class="inner"><span>get-all-by-spec</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-graph-transaction-data"><div class="inner"><span>graph-transaction-data</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-instance-transaction-data"><div class="inner"><span>instance-transaction-data</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-q"><div class="inner"><span>q</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-refresh"><div class="inner"><span>refresh</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-retract.21"><div class="inner"><span>retract!</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-update.21"><div class="inner"><span>update!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h2 class="anchor" id="top">spark.spec-tacular.datomic</h2><div class="doc"><div class="markdown"><p>Datomic interface for the spec-tacular DSL</p></div></div><div class="public anchor" id="var-assoc.21"><h3>assoc!</h3><div class="usage"><code>(assoc! conn-ctx si &amp; {:as updates})</code></div><div class="doc"><div class="markdown"><p>Updates the given entity in database in the given connection. Returns the new entity.</p><p>The entity must be an object representation of an entity on the database (for example, returned from a query, <a href="spark.spec-tacular.datomic.html#var-create.21">create!</a>, or an earlier <a href="spark.spec-tacular.datomic.html#var-assoc.21">assoc!</a>).</p><p><em>Attempting to retract a <code>:component</code> field (by setting that field to <code>nil</code>) retracts the entire component instance.</em></p><p>Get the Datomic <code>:db/id</code> from the object using the <code>:db-ref</code> field.</p><p>Aborts if the entity does not exist in the database (use <a href="spark.spec-tacular.datomic.html#var-create.21">create!</a> instead).</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1279">view source</a></div></div><div class="public anchor" id="var-ConnCtx"><h3>ConnCtx</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>A connection context. The only mandatory field is the <code>:conn</code>,  which provides the actual connection to the database.</p><p>Other option fields include:</p>
<ul>
  <li><code>:transaction-log</code>, any object which can be converted to Datomic transaction data</li>
</ul><p>(t/HMap  :mandatory  {:conn Connection}  :optional  {:transaction-log t/Any})</p></div></div></div><div class="public anchor" id="var-Connection"><h3>Connection</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>datomic.peer.LocalConnection</p></div></div></div><div class="public anchor" id="var-count-all-by-spec"><h3>count-all-by-spec</h3><div class="usage"><code>(count-all-by-spec db spec)</code></div><div class="doc"><div class="markdown"><p>Returns the number of entities with the given spec in the database.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L200">view source</a></div></div><div class="public anchor" id="var-create.21"><h3>create!</h3><div class="usage"><code>(create! conn-ctx new-si)</code></div><div class="doc"><div class="markdown"><p>Creates a new instance of the given entity on the database in the given connection context. Returns a representation of the newly created object.</p><p>Get the Datomic <code>:db/id</code> from the object using the <code>:db-ref</code> field.</p><p>Aborts if the entity already exists in the database (use <a href="spark.spec-tacular.datomic.html#var-assoc.21">assoc!</a> instead).</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1267">view source</a></div></div><div class="public anchor" id="var-create-graph.21"><h3>create-graph!</h3><div class="usage"><code>(create-graph! conn-ctx new-si-coll)</code></div><div class="doc"><div class="markdown"><p>Creates every new instance contained in the given collection, and returns the new instances in a collection of the same type, and in the same order where applicable. For every object that is <code>identical?</code> in the given graph, only one instance is created on the database.</p><p>create-graph! does <em>not</em> support arbitrarly nested collections.</p><p>Currently supports sets, lists, vector, and sequences.</p><p>Aborts if any entities already exist on the database.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1239">view source</a></div></div><div class="public anchor" id="var-Database"><h3>Database</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>datomic.db.Db</p></div></div></div><div class="public anchor" id="var-db"><h3>db</h3><div class="usage"><code>(db conn-ctx)</code></div><div class="doc"><div class="markdown"><p>Returns the database in a given connection context.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L67">view source</a></div></div><div class="public anchor" id="var-get-all-by-spec"><h3>get-all-by-spec</h3><h4 class="type">macro</h4><div class="usage"><code>(get-all-by-spec db spec)</code></div><div class="doc"><div class="markdown"><p>Returns all the entities in the database with the given spec.</p><p>If the spec is a keyword at compile-time, the resulting entity is cast to the correct type. Otherwise, the resulting entity is a generic <a href="spark.spec-tacular.html#var-SpecInstance">SpecInstance</a></p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L180">view source</a></div></div><div class="public anchor" id="var-graph-transaction-data"><h3>graph-transaction-data</h3><div class="usage"><code>(graph-transaction-data conn-ctx new-si-coll)</code></div><div class="doc"><div class="markdown"><p>Returns Datomic transaction data that would create the given graph on the database given in <code>conn-ctx</code>. Also contains meta-data <code>:tmpids</code> and <code>:specs</code> for the expected temp-ids and specs, respectively.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1204">view source</a></div></div><div class="public anchor" id="var-instance-transaction-data"><h3>instance-transaction-data</h3><div class="usage"><code>(instance-transaction-data conn-ctx new-si)</code></div><div class="doc"><div class="markdown"><p>Returns the Datomic transaction data that would create the given spec instance on the database given in <code>conn-ctx</code>.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1230">view source</a></div></div><div class="public anchor" id="var-q"><h3>q</h3><h4 class="type">macro</h4><div class="usage"><code>(q &amp; stx)</code></div><div class="doc"><div class="markdown"><p>Returns a set of results from the Datomic query. See <a href="https://github.com/SparkFund/spec-tacular/tree/v0.5.0#querying-databases">the README</a> for examples.</p>
<pre><code>(q :find FIND-EXPR+ :in expr :where CLAUSE+)

FIND-EXPR = IDENT 
          | [IDENT ...]
IDENT     = SpecName
          | ?variable
          | [SpecName ?variable]
CLAUSE    = [IDENT MAP]
          | [(symbol (SpecName | ?variable)+)]
MAP       = % | %n | SpecName
          | {keyword (CLAUSE | MAP | IDENT | expr),+}
</code></pre><p>The <code>FIND-EXPR</code> are used as the <code>:find</code> arguments to the Datomic query.</p><p>The value of <code>:in</code> is used as the database; no other arguments to <code>:in</code> are allowed at the moment.</p><p>Each <code>:where</code> clause is expanded to one or more Datomic clauses. The <code>[IDENT MAP]</code> form finds <code>IDENT</code>s with the fields given in <code>MAP</code>. The other clause syntax provides very experimental support for a subset of Datomic <a href="http://docs.datomic.com/query.html">&ldquo;Function Expressions&rdquo;</a> &ndash; more coming soon.</p><p>Using <code>%</code> and <code>%n</code> is analogous to <code>#</code> and <code>%</code> in Clojure: <code>%</code> inserts the first SpecName in the <code>FIND-EXPR</code> if there is only one, or <code>%1</code> references the first, and <code>%2</code> the second, etc.</p><p>Every <code>SpecName</code> must be a keyword at compile-time; to dynamically get the spec of an entity use the special keyword <code>:spec-tacular/spec</code> as an entry in any <code>MAP</code>.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1018">view source</a></div></div><div class="public anchor" id="var-refresh"><h3>refresh</h3><div class="usage"><code>(refresh conn-ctx si)</code></div><div class="doc"><div class="markdown"><p>Returns an updated representation of the Datomic entity at the given instance&rsquo;s <code>:db-ref</code>.</p><p>The entity must be an object representation of an entity on the database (see <a href="spark.spec-tacular.datomic.html#var-assoc.21">assoc!</a> for an explanation).</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1315">view source</a></div></div><div class="public anchor" id="var-retract.21"><h3>retract!</h3><h4 class="added">added in 0.5.1</h4><div class="usage"><code>(retract! conn-ctx si &amp; [field-name])</code></div><div class="doc"><div class="markdown"><p>Removes the given instance from the database using <code>:db.fn/retractEntity</code>. Returns <code>nil</code>.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1331">view source</a></div></div><div class="public anchor" id="var-update.21"><h3>update!</h3><div class="usage"><code>(update! conn-ctx si-old si-new)</code></div><div class="doc"><div class="markdown"><p>Calculate a shallow difference between the two spec instances and uses <a href="spark.spec-tacular.datomic.html#var-assoc.21">assoc!</a> to change the entity on the database.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/tree/develop/src/spark/spec_tacular/datomic.clj#L1303">view source</a></div></div></div></body></html>