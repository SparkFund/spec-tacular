<!DOCTYPE html>
<html><head><meta charset="UTF-8"><link href="css/default.css" rel="stylesheet" type="text/css"><script src="js/jquery.min.js" type="text/javascript"></script><script src="js/page_effects.js" type="text/javascript"></script><title>spark.spec-tacular.datomic documentation</title></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Spec-tacular</span> <span class="project-version">0.6.0-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spark</span></div></div></li><li class="depth-2"><a href="spark.spec-tacular.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>spec-tacular</span></div></a></li><li class="depth-3 branch current"><a href="spark.spec-tacular.datomic.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>datomic</span></div></a></li><li class="depth-3 branch"><a href="spark.spec-tacular.generators.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generators</span></div></a></li><li class="depth-3"><a href="spark.spec-tacular.schema.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>schema</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-assoc.21"><div class="inner"><span>assoc!</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-backwards"><div class="inner"><span>backwards</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-ConnCtx"><div class="inner"><span>ConnCtx</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-Connection"><div class="inner"><span>Connection</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-count-all-by-spec"><div class="inner"><span>count-all-by-spec</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-create.21"><div class="inner"><span>create!</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-create-graph.21"><div class="inner"><span>create-graph!</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-Database"><div class="inner"><span>Database</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-DatabaseId"><div class="inner"><span>DatabaseId</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-db"><div class="inner"><span>db</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-get-all-by-spec"><div class="inner"><span>get-all-by-spec</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-graph-transaction-data"><div class="inner"><span>graph-transaction-data</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-instance-transaction-data"><div class="inner"><span>instance-transaction-data</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-pull"><div class="inner"><span>pull</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-q"><div class="inner"><span>q</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-query"><div class="inner"><span>query</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-refresh"><div class="inner"><span>refresh</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-retract.21"><div class="inner"><span>retract!</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-transaction-log-data"><div class="inner"><span>transaction-log-data</span></div></a></li><li class="depth-1"><a href="spark.spec-tacular.datomic.html#var-update.21"><div class="inner"><span>update!</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">spark.spec-tacular.datomic</h1><div class="doc"><div class="markdown"><p>Datomic interface for the spec-tacular DSL</p></div></div><div class="public anchor" id="var-assoc.21"><h3>assoc!</h3><div class="usage"><code>(assoc! conn-ctx si &amp; {:as updates})</code></div><div class="doc"><div class="markdown"><p>Updates the given entity in database in the given connection. Returns the new entity.</p>
<p>The entity must be an object representation of an entity on the database (for example, returned from a query, <a href="spark.spec-tacular.datomic.html#var-create.21">create!</a>, or an earlier <a href="spark.spec-tacular.datomic.html#var-assoc.21">assoc!</a>).</p>
<p><em>Attempting to retract a <code>:component</code> field (by setting that field to <code>nil</code>) retracts the entire component instance.</em></p>
<p>Get the Datomic <code>:db/id</code> from the object using the <code>:db-ref</code> field.</p>
<p>Aborts if the entity does not exist in the database (use <a href="spark.spec-tacular.datomic.html#var-create.21">create!</a> instead).</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L460">view source</a></div></div><div class="public anchor" id="var-backwards"><h3>backwards</h3><div class="usage"><code>(backwards spec-name kw)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L528">view source</a></div></div><div class="public anchor" id="var-ConnCtx"><h3>ConnCtx</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>A connection context. The only mandatory field is the <code>:conn</code>, which provides the actual connection to the database.</p>
<p>Other option fields include:</p>
<ul>
  <li><code>:transaction-log</code>, any object which can be converted to Datomic  transaction data</li>
</ul></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L32">view source</a></div></div><div class="public anchor" id="var-Connection"><h3>Connection</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L30">view source</a></div></div><div class="public anchor" id="var-count-all-by-spec"><h3>count-all-by-spec</h3><div class="usage"><code>(count-all-by-spec db spec)</code></div><div class="doc"><div class="markdown"><p>Returns the number of entities with the given spec in the database.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L122">view source</a></div></div><div class="public anchor" id="var-create.21"><h3>create!</h3><div class="usage"><code>(create! conn-ctx new-si)</code></div><div class="doc"><div class="markdown"><p>Creates a new instance of the given entity on the database in the given connection context. Returns a representation of the newly created object.</p>
<p>Get the Datomic <code>:db/id</code> from the object using the <code>:db-ref</code> field.</p>
<p>Aborts if the entity already exists in the database (use <a href="spark.spec-tacular.datomic.html#var-assoc.21">assoc!</a> instead).</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L448">view source</a></div></div><div class="public anchor" id="var-create-graph.21"><h3>create-graph!</h3><div class="usage"><code>(create-graph! conn-ctx new-si-coll)</code></div><div class="doc"><div class="markdown"><p>Creates every new instance contained in the given collection, and returns the new instances in a collection of the same type, and in the same order where applicable. For every object that is <code>identical?</code> in the given graph, only one instance is created on the database.</p>
<p>create-graph! does <em>not</em> support arbitrarly nested collections.</p>
<p>Currently supports sets, lists, vector, and sequences.</p>
<p>Aborts if any entities already exist on the database.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L416">view source</a></div></div><div class="public anchor" id="var-Database"><h3>Database</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L27">view source</a></div></div><div class="public anchor" id="var-DatabaseId"><h3>DatabaseId</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L28">view source</a></div></div><div class="public anchor" id="var-db"><h3>db</h3><div class="usage"><code>(db conn-ctx)</code></div><div class="doc"><div class="markdown"><p>Returns the database in a given connection context.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L57">view source</a></div></div><div class="public anchor" id="var-get-all-by-spec"><h3>get-all-by-spec</h3><h4 class="type">macro</h4><div class="usage"><code>(get-all-by-spec db spec)</code></div><div class="doc"><div class="markdown"><p>Returns all the entities in the database with the given spec.</p>
<p>If the spec is a keyword at compile-time, the resulting entity is cast to the correct type. Otherwise, the resulting entity is a generic <a href="spark.spec-tacular.html#var-SpecInstance">SpecInstance</a></p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L102">view source</a></div></div><div class="public anchor" id="var-graph-transaction-data"><h3>graph-transaction-data</h3><div class="usage"><code>(graph-transaction-data conn-ctx new-si-coll)</code></div><div class="doc"><div class="markdown"><p>Returns Datomic transaction data that would create the given graph on the database given in <code>conn-ctx</code>. Also contains meta-data <code>:tmpids</code> and <code>:specs</code> for the expected temp-ids and specs, respectively.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L386">view source</a></div></div><div class="public anchor" id="var-instance-transaction-data"><h3>instance-transaction-data</h3><div class="usage"><code>(instance-transaction-data conn-ctx new-si)</code></div><div class="doc"><div class="markdown"><p>Returns the Datomic transaction data that would create the given spec instance on the database given in <code>conn-ctx</code>.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L407">view source</a></div></div><div class="public anchor" id="var-pull"><h3>pull</h3><div class="usage"><code>(pull db pattern instance)</code></div><div class="doc"><div class="markdown"><p>Executes a Datomic pull after datomifying the given pattern with respect to the given instance.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L533">view source</a></div></div><div class="public anchor" id="var-q"><h3>q</h3><h4 class="type">macro</h4><div class="usage"><code>(q &amp; stx)</code></div><div class="doc"><div class="markdown"><p>Returns a set of results from the Datomic query. See <a href="https://github.com/SparkFund/spec-tacular/tree/v0.5.0#querying-databases">the README</a> for examples. Also see <a href="http://docs.datomic.com/query.html">Datomic&rsquo;s documentation</a> for query, which we both restrict and expand upon.</p>
<pre><code>(q :find FIND-EXPR+ :in DB-EXPR :where CLAUSE+)

FIND-EXPR   = VAR
            | VAR .
            | (pull VAR pattern)
            | (instance SpecName ?variable)
            | (aggregate expr* VAR)
            | [VAR+ ]
            | [VAR ...]
DB-EXPR     | expr
VAR         = ?variable
            | SpecName
CLAUSE      = SPEC-CLAUSE
            | any otherwise valid Datomic clause
SPEC-CLAUSE = [SpecName SPEC-RHS]
            | [?variable [SpecName SPEC-RHS]]
SPEC-RHS    = % | %n | SpecName
            | {keyword (SPEC-CLAUSE | expr),+}
</code></pre>
<p>Every <code>SpecName</code> must be a keyword at compile-time. Every <code>?variable</code> is quoted, so you do not have to quote them yourself. Anything <code>expr</code> that is not a <code>?variable</code> or a <code>SpecName</code> is left unchanged (so you can perform operations inside of queries as long as it does not confuse the query syntax).</p>
<p>The <code>FIND-EXPR</code> are used as the <code>:find</code> arguments to the Datomic query. The syntax is the same, except we include <code>(instance
SpecName ?variable)</code> for casting any database type to <code>SpecName</code> on its way off the database. This is done automatically for <code>FIND-EXPRS</code> that terminate with <code>SpecName</code>s rather than <code>?variable</code>s. The <code>aggregate</code> function must adhere to Datomic&rsquo;s requirements: either one of the build-in aggregators or a fully qualified function already imported into the namespace, where the aggregated variable is the final argument.</p>
<p>The value of <code>:in</code> is used as the database; no other arguments to <code>:in</code> are allowed at the moment.</p>
<p>Each <code>:where</code> clause is expanded to one or more Datomic clauses. All Datomic where clause syntax is (intended to be) supported. The <code>SPEC-CLAUSE</code> form finds spec-tacular instances on the database with the fields given in <code>SPEC-RHS</code>.</p>
<p>Using <code>%</code> and <code>%n</code> is analogous to <code>#</code> and <code>%</code> in Clojure: <code>%</code> inserts the first <code>SpecName</code> in the <code>FIND-EXPR</code> if there is only one, or <code>%1</code> references the first, and <code>%2</code> the second, etc.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L153">view source</a></div></div><div class="public anchor" id="var-query"><h3>query</h3><h4 class="added">added in 0.6.0</h4><div class="usage"><code>(query {find-elems :find, clauses :where, :as m} &amp; args)</code></div><div class="doc"><div class="markdown"><p>Runtime support for spec-tacular queries. Akin to the map syntax for <code>datomic.api/q</code>, this form expects data (rather than syntax), and attempts to unroll spec-tacular maps into valid Datomic <code>:where</code> clauses.</p>
<pre><code>(query {:find FIND-EXPR :in IN-EXPR :where (WHERE-CLAUSE+)} expr+)

FIND-EXPR   = VAR
            | VAR .
            | (spec-pull VAR SpecName spec-tacular-pattern)
            | (pull VAR datomic-pattern)
            | (instance SpecName ?variable)
            | [VAR+ ]
            | [VAR ...]
DB-EXPR     | expr
VAR         = ?variable
            | SpecName
CLAUSE      = SPEC-CLAUSE
            | any otherwise valid Datomic clause
SPEC-CLAUSE = [?variable SPEC-RHS]
SPEC-RHS    | {:spec-tacular/spec SpecName,
               keyword (?variable | constant | spec-instance),+}
</code></pre>
<p>Note that <code>SPEC-RHS</code> is no longer recursive via <code>SPEC-CLAUSE</code>. If <code>SpecName</code> names a UnionSpec, we create an <code>or</code> that tries every branch.</p>
<p>If any <code>Exception</code>s occur enroute, a <code>clojure.lang.ExceptionInfo</code> is thrown with additional information about the query that was executed.</p>
<p>This function uses <code>spark.spec-tacular.datomic.query-helpers</code> in order to datomify the <code>FIND-EXPR</code> and each <code>WHERE-CLAUSE</code>.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L222">view source</a></div></div><div class="public anchor" id="var-refresh"><h3>refresh</h3><div class="usage"><code>(refresh conn-ctx si)</code></div><div class="doc"><div class="markdown"><p>Returns an updated representation of the Datomic entity at the given instance&rsquo;s <code>:db-ref</code>.</p>
<p>The entity must be an object representation of an entity on the database (see <a href="spark.spec-tacular.datomic.html#var-assoc.21">assoc!</a> for an explanation).</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L499">view source</a></div></div><div class="public anchor" id="var-retract.21"><h3>retract!</h3><h4 class="added">added in 0.5.1</h4><div class="usage"><code>(retract! conn-ctx si &amp; [field-name])</code></div><div class="doc"><div class="markdown"><p>Removes the given instance from the database using <code>:db.fn/retractEntity</code>. Returns <code>nil</code>.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L515">view source</a></div></div><div class="public anchor" id="var-transaction-log-data"><h3>transaction-log-data</h3><div class="usage"><code>(transaction-log-data conn-ctx)</code></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L131">view source</a></div></div><div class="public anchor" id="var-update.21"><h3>update!</h3><div class="usage"><code>(update! conn-ctx si-old si-new)</code></div><div class="doc"><div class="markdown"><p>Calculate a shallow difference between the two spec instances and uses <a href="spark.spec-tacular.datomic.html#var-assoc.21">assoc!</a> to change the entity on the database.</p></div></div><div class="src-link"><a href="https://github.com/SparkFund/spec-tacular/blob/develop/src/spark/spec_tacular/datomic.clj#L487">view source</a></div></div></div></body></html>